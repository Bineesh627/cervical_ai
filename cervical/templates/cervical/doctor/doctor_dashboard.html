{% extends 'cervical/shared/base.html' %} {% load static %} {% block content %}

<div class="doctor-dashboard-layout">
  <h1 class="page-header">
    <i class="fas fa-notes-medical"></i> Doctor Dashboard
  </h1>

  <div class="stats-panel panel">
    <h2 class="section-title">
      <i class="fas fa-chart-line"></i> Performance Overview
    </h2>
    <div class="stats-cards">
      <div class="stat-card">
        <i class="fas fa-users icon-large"></i>
        <h4>Total Patients</h4>
        <p class="stat-number">{{ total_patients|default:"0" }}</p>
      </div>
      <div class="stat-card high-priority">
        <i class="fas fa-exclamation-triangle icon-large"></i>
        <h4>High Risk Cases (Latest)</h4>
        <p class="stat-number">{{ high_risk_count|default:"0" }}</p>
      </div>
      <div class="stat-card message-count">
        <i class="fas fa-envelope icon-large"></i>
        <h4>Unanswered Messages</h4>
        <p class="stat-number">{{ unanswered_messages|default:"0" }}</p>
      </div>
      <div class="stat-card total-tests">
        <i class="fas fa-flask icon-large"></i>
        <h4>Tests Performed</h4>
        <p class="stat-number">{{ total_tests|default:"0" }}</p>
      </div>
    </div>
  </div>

  <div class="main-content-grid">
    <div class="records-panel">
      <h2 class="section-title">
        <i class="fas fa-folder-open"></i> Patient Records List
      </h2>

      {% for p in patients %}
      <div class="patient-card card-professional">
        <header class="patient-header">
          <div class="patient-info">
            <i class="fas fa-user-injured patient-icon"></i>
            <h4>{{ p.user.get_full_name|default:p.user.email }}</h4>
            <span class="muted-info"
              >({{ p.sex|default:"N/A" }} / {{ p.age|default:"N/A" }} yrs)</span
            >
          </div>
        </header>

        {% with latest_record=p.records.all|first %} {% if latest_record %}
        <div class="latest-record-summary">
          <div class="summary-item">
            <i class="fas fa-calendar-alt"></i>
            <span>Last Test:</span>
            <strong>{{ latest_record.created_at|date:"Y-m-d H:i" }}</strong>
          </div>
          <div class="summary-item">
            <i class="fas fa-chart-pie"></i>
            <span>Fused Result:</span>
            <strong class="label-{{ latest_record.fused_label|lower }}">
              {{ latest_record.fused_label }}
            </strong>
          </div>
        </div>

        <div class="action-bar">
          <a
            href="{% url 'doctor_view_patient_record' latest_record.id %}"
            class="btn primary view-details-btn"
          >
            Review Record <i class="fas fa-arrow-right"></i>
          </a>
        </div>

        {% else %}
        <div class="action-bar">
          <p class="muted-text">No test records available yet.</p>
        </div>
        {% endif %} {% endwith %}
      </div>
      {% empty %}
      <div class="empty-state">
        <p>No registered patients found.</p>
        <a href="{% url 'login' %}" class="btn primary large">
          <i class="fas fa-user-plus"></i> Invite New Patients
        </a>
      </div>
      {% endfor %}
    </div>

    <div class="messages-panel">
      <h2 class="section-title">
        <i class="fas fa-comments"></i> Patient Messages
      </h2>

      {% for m in messages %}
      <div class="message-card {% if not m.is_answered %}unanswered{% endif %}">
        <div class="message-header">
          <p class="message-sender">
            <i class="fas fa-user-injured"></i> From:
            <strong>{{ m.sender.get_full_name|default:m.sender.email }}</strong>
          </p>
          <span class="message-date">{{ m.created_at|date:"Y-m-d H:i" }}</span>
        </div>

        <p class="message-record-link">
          (Record:
          <a href="{% url 'doctor_view_patient_record' m.record.id %}"
            >#{{ m.record.id }}</a
          >)
        </p>

        <blockquote class="patient-query">"{{ m.question }}"</blockquote>

        {% if not m.is_answered %}
        <form
          method="post"
          action="{% url 'doctor_view_patient_record' m.record.id %}"
          class="reply-form"
        >
          {% csrf_token %}
          <input type="hidden" name="message_id" value="{{ m.id }}" />
          <textarea
            name="reply_text"
            placeholder="Type your professional reply here..."
            class="reply-textarea"
          ></textarea>
          <button
            name="reply_message"
            class="btn primary small-btn send-reply-btn"
          >
            <i class="fas fa-paper-plane"></i> Send Reply
          </button>
        </form>
        {% else %}
        <div class="response-block">
          <p>
            <strong><i class="fas fa-reply"></i> Your Response:</strong>
          </p>
          <p class="response-text">{{ m.answer }}</p>
        </div>
        {% endif %}
      </div>
      {% empty %}
      <div class="empty-state-messages">
        <i class="far fa-check-circle"></i>
        <p class="muted-text">All caught up! No new messages from patients.</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<style>
  /* --- 0. COLOR PALETTE & VARIABLES (Modern Dark Theme) --- */
  :root {
    --color-bg-primary: #12121e; /* Very Dark Purple/Blue */
    --color-card-primary: #1e2536; /* Deep Slate for Cards */
    --color-card-secondary: #272f41; /* Lighter Slate for hover/elements */

    --color-accent: #6366f1; /* Vibrant Indigo/Blue for primary focus */
    --color-accent-light: #818cf8;
    --color-text: #e2e8f0; /* Light text */
    --color-muted: #94a3b8; /* Muted gray for secondary info */

    /* Status Colors */
    --color-status-low: #10b981; /* Emerald Green */
    --color-status-medium: #facc15; /* Yellow */
    --color-status-high: #ef4444; /* Bright Red */
  }

  /* Apply base styling to body (Assuming parent base.html handles basic reset) */
  body {
    background-color: var(--color-bg-primary);
    color: var(--color-text);
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }

  /* --- 1. LAYOUT & GRID --- */
  .doctor-dashboard-layout {
    padding: 40px;
    max-width: 1600px;
    margin: 0 auto;
  }

  .page-header {
    font-size: 2.5rem;
    color: var(--color-text);
    margin-bottom: 30px;
    font-weight: 700;
    border-bottom: 3px solid var(--color-accent);
    padding-bottom: 15px;
  }
  .page-header i {
    color: var(--color-accent-light);
    margin-right: 15px;
  }

  /* Main Content Grid: Records and Messages */
  .main-content-grid {
    display: grid;
    grid-template-columns: 2fr 1fr; /* 2 parts for records, 1 part for messages */
    gap: 30px;
    margin-top: 30px;
  }

  /* Shared Panel & Section Styles */
  .panel {
    background-color: var(--color-card-primary);
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
  }

  .records-panel,
  .messages-panel {
    padding: 0; /* Remove padding here, cards handle it */
  }

  .section-title {
    color: var(--color-accent-light);
    padding: 15px 0;
    margin-bottom: 25px;
    font-size: 1.5rem;
    font-weight: 600;
  }
  .records-panel .section-title,
  .messages-panel .section-title {
    padding: 20px 0 15px 0;
  }
  .section-title i {
    margin-right: 10px;
    color: var(--color-accent);
  }

  /* --- 2. STATS PANEL STYLES --- */
  .stats-cards {
    display: flex;
    justify-content: space-between;
    gap: 20px;
  }

  .stat-card {
    flex: 1;
    text-align: center;
    padding: 25px 15px;
    border-radius: 12px;
    background-color: var(--color-card-secondary);
    border-bottom: 4px solid var(--color-accent);
    transition: transform 0.3s ease;
  }
  .stat-card:hover {
    transform: translateY(-5px);
  }

  .stat-card h4 {
    color: var(--color-muted);
    font-size: 0.9rem;
    margin-bottom: 8px;
    font-weight: 500;
  }

  .stat-number {
    font-size: 2.8rem;
    font-weight: 800;
    color: var(--color-text);
  }

  .icon-large {
    font-size: 2.2rem;
    color: var(--color-accent-light);
    margin-bottom: 15px;
  }

  .stat-card.high-priority {
    border-color: var(--color-status-high);
  }
  .stat-card.message-count {
    border-color: var(--color-status-medium);
  }
  .stat-card.total-tests {
    border-color: var(--color-status-low);
  }

  .stat-card.high-priority .stat-number {
    color: var(--color-status-high);
  }
  .stat-card.message-count .stat-number {
    color: var(--color-status-medium);
  }
  .stat-card.total-tests .stat-number {
    color: var(--color-status-low);
  }

  /* --- 3. PATIENT RECORDS STYLES --- */
  .patient-card {
    background-color: var(--color-card-secondary);
    padding: 25px;
    margin-bottom: 20px;
    border-radius: 12px;
    border-left: 5px solid var(--color-accent);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .patient-card:hover {
    transform: scale(1.01);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
  }

  .patient-header {
    display: flex;
    align-items: center;
    padding-bottom: 15px;
    margin-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .patient-info h4 {
    margin: 0;
    font-size: 1.3rem;
    color: var(--color-text);
    font-weight: 700;
  }

  .patient-icon {
    font-size: 1.8rem;
    color: var(--color-accent-light);
    margin-right: 20px;
  }

  .muted-info {
    font-size: 0.9rem;
    color: var(--color-muted);
    display: block;
    margin-top: 5px;
  }

  .latest-record-summary {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    font-size: 1rem;
    color: var(--color-text);
  }

  .summary-item i {
    color: var(--color-accent);
    margin-right: 8px;
  }
  .summary-item span {
    color: var(--color-muted);
    margin-right: 5px;
  }

  .action-bar {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
  }

  /* Buttons */
  .btn {
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 600;
    text-decoration: none;
    transition: background-color 0.3s ease;
  }
  .btn.primary {
    background-color: var(--color-accent);
    color: var(--color-bg-primary);
  }
  .btn.primary:hover {
    background-color: var(--color-accent-light);
  }

  /* Color Coding for Labels (High/Medium/Low) */
  .label-high {
    color: var(--color-status-high);
  }
  .label-medium {
    color: var(--color-status-medium);
  }
  .label-low {
    color: var(--color-status-low);
  }

  /* --- 4. MESSAGES PANEL STYLES --- */
  .messages-panel {
    height: 100%; /* Fill the container space */
    overflow-y: auto; /* Allow scrolling */
    max-height: 80vh; /* Prevents panel from expanding infinitely */
  }

  .message-card {
    background-color: var(--color-card-secondary);
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    border-left: 4px solid var(--color-muted);
    transition: border-color 0.3s ease;
  }

  .message-card.unanswered {
    border-left: 4px solid var(--color-status-high); /* Highlight unanswered messages */
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
  }

  .message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
  }

  .message-sender {
    font-size: 0.95rem;
    color: var(--color-muted);
  }

  .message-sender strong {
    color: var(--color-text);
  }

  .message-record-link {
    font-size: 0.85rem;
    color: var(--color-muted);
    margin-bottom: 10px;
  }
  .message-record-link a {
    color: var(--color-accent);
    text-decoration: none;
  }

  .message-date {
    font-size: 0.75rem;
    color: var(--color-muted);
  }

  .patient-query {
    font-style: italic;
    color: var(--color-text);
    padding: 10px 15px;
    background-color: rgba(99, 102, 241, 0.1);
    border-left: 3px solid var(--color-accent);
    margin: 10px 0 15px 0;
    border-radius: 4px;
  }

  .reply-form textarea {
    width: 100%;
    min-height: 80px;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
    background-color: var(--color-card-primary);
    border: 1px solid var(--color-accent);
    color: var(--color-text);
    resize: vertical;
  }

  .response-block {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .response-block strong {
    color: var(--color-accent);
  }

  .response-text {
    color: var(--color-muted);
    font-size: 0.9rem;
    margin-top: 5px;
  }

  /* Empty States */
  .empty-state {
    padding: 40px;
    text-align: center;
    background-color: var(--color-card-secondary);
    border: 2px dashed var(--color-accent);
    border-radius: 12px;
    margin-top: 20px;
  }

  .empty-state p {
    color: var(--color-muted);
    font-size: 1.1rem;
    margin-bottom: 20px;
  }

  .empty-state-messages {
    text-align: center;
    padding: 40px;
  }
  .empty-state-messages i {
    font-size: 3rem;
    color: var(--color-status-low);
    margin-bottom: 15px;
  }

  /* --- 5. RESPONSIVENESS --- */
  @media (max-width: 1200px) {
    .main-content-grid {
      grid-template-columns: 1fr; /* Stack records and messages vertically */
    }
    .messages-panel {
      max-height: none; /* Remove height constraint when stacked */
    }
  }

  @media (max-width: 768px) {
    .doctor-dashboard-layout {
      padding: 20px;
    }
    .page-header {
      font-size: 2rem;
    }
    .stats-cards {
      flex-direction: column;
    }
    .stat-card {
      padding: 20px;
    }
    .patient-header {
      flex-direction: column;
      align-items: flex-start;
    }
    .patient-icon {
      margin-bottom: 10px;
    }
    .latest-record-summary {
      flex-direction: column;
      gap: 10px;
    }
  }
</style>

{% endblock %}
