 {% extends 'cervical/shared/base.html' %} {% load static %} {% block content %}
{% comment %}
<div class="dashboard-layout">
  <aside class="side-panel">
    <div class="profile-header-card">
      <i class="fas fa-user-shield profile-icon"></i>
      <h3 class="profile-name">
        {{ profile.user.get_full_name|default:'Patient User' }}
      </h3>
      <span class="profile-role">Patient ID: {{ profile.user.id }}</span>
    </div>

    <div class="data-block">
      <h4 class="block-title">
        <i class="fas fa-id-card-alt"></i> Personal Details
      </h4>
      <div class="data-grid">
        <div class="data-item">
          <span class="data-label"><i class="fas fa-venus-mars"></i> Sex</span>
          <span class="data-value">{{ profile.sex|default:'N/A' }}</span>
        </div>
        <div class="data-item">
          <span class="data-label"
            ><i class="fas fa-calendar-alt"></i> Age</span
          >
          <span class="data-value">{{ profile.age|default:'N/A' }}</span>
        </div>
        <div class="data-item">
          <span class="data-label"
            ><i class="fas fa-tint"></i> Blood Group</span
          >
          <span class="data-value"
            >{{ profile.blood_group|default:'N/A' }}</span
          >
        </div>
      </div>
    </div>

    <div class="action-buttons-stack">
      <a href="{% url 'clinical_entry' %}" class="action-btn-primary">
        <i class="fas fa-notes-medical"></i> Enter Clinical Data
      </a>
      <a href="{% url 'upload_pap' %}" class="action-btn-secondary">
        <i class="fas fa-upload"></i> Upload Pap Image
      </a>
      <a href="{% url 'update_patient_profile' %}" class="action-btn-tertiary">
        <i class="fas fa-user-edit"></i> Edit Profile
      </a>
    </div>
  </aside>

  <section class="main-content">
    <h2 class="section-title">
      <i class="fas fa-history"></i> Comprehensive Test History
    </h2>

    {% for r in records %}
    <div class="test-record-card">
      <header class="record-card-header">
        <span class="test-date-time">
          <i class="far fa-clock"></i> {{ r.created_at|date:"F j, Y, h:i A" }}
        </span>

        <div class="status-tags">
          {% if r.referral_status == 'R' %}
          <span class="tag-alert referred-tag">
            <i class="fas fa-user-md"></i> Consult Required
          </span>
          {% elif r.fused_label == 'High' %}
          <span class="tag-alert high-risk-tag">
            <i class="fas fa-radiation"></i> High Risk Result
          </span>
          {% elif r.fused_label == 'Medium' %}
          <span class="tag-alert medium-risk-tag">
            <i class="fas fa-exclamation-circle"></i> Medium Risk
          </span>
          {% else %}
          <span class="tag-alert low-risk-tag">
            <i class="fas fa-check-circle"></i> Low Risk
          </span>
          {% endif %}
        </div>

        <a href="{% url 'patient_detail' r.id %}" class="view-details-link">
          View Full Report <i class="fas fa-arrow-right"></i>
        </a>
      </header>

<div class="prediction-summary-grid">
  <div class="prediction-tile clinical-tile">
    <div class="tile-header">
      <i class="fas fa-stethoscope"></i> Clinical Prediction
    </div>
    <div class="tile-body">
      <span class="tile-label-main label-{{ record.clinical_pred_label|default:'n/a'|lower }}">
        {{ record.clinical_pred_label|default:'N/A' }}
      </span>
      <span class="tile-score">
        Risk Score: {{ record.clinical_risk_score|default:'N/A'|floatformat:3 }}
      </span>
    </div>
  </div>
</div>


        <div class="prediction-tile image-tile">
          <div class="tile-header">
            <i class="fas fa-microscope"></i> Image Prediction
          </div>
          <div class="tile-body">
            <span class="tile-label-main label-{{ r.image_label|lower }}">
              {{ r.image_label|default:'N/A' }}
            </span>
            <span class="tile-score">
              Probability: {{ r.image_prob|floatformat:2|default:'N/A' }}
            </span>
          </div>
        </div>

        <div class="prediction-tile fused-tile">
          <div class="tile-header">
            <i class="fas fa-brain"></i> Fused Final Result
          </div>
          <div class="tile-body">
            <span class="tile-label-final label-{{ r.fused_label|lower }}">
              {{ r.fused_label|default:'N/A' }}
            </span>
            <span class="tile-score">
              Fusion Score: {{ r.fused_score|floatformat:2|default:'N/A' }}
            </span>
          </div>
        </div>
      </div>

      <div class="explanation-visuals-section">
        <h6 class="visual-section-title">
          <i class="fas fa-chart-bar"></i> AI Explanation:
        </h6>
        <div class="visuals-container">
          {% if r.gradcam_path %}
          <figure class="visual-figure">
            <img
              src="{% static r.gradcam_path|slice:'7:' %}"
              alt="GradCAM Visualization"
              title="Image Explanation (Grad-CAM)"
            />
            <figcaption>Grad-CAM</figcaption>
          </figure>
          {% endif %} {% if r.clinical_shap_path %}
          <figure class="visual-figure">
            <img
              src="{% static r.clinical_shap_path|slice:'7:' %}"
              alt="SHAP Explanation"
              title="Clinical Explanation (SHAP)"
            />
            <figcaption>SHAP Plot</figcaption>
          </figure>
          {% endif %} {% if not r.gradcam_path and not r.clinical_shap_path %}
          <p class="no-visuals-text">
            <i class="fas fa-eye-slash"></i> No detailed visualizations
            available for this test.
          </p>
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <div class="empty-state-advanced">
      <i class="fas fa-folder-open"></i>
      <p>Your record history is currently empty.</p>
      <p>Start your journey by submitting a new test for analysis.</p>
      <a
        href="{% url 'clinical_entry' %}"
        class="action-btn-primary large-empty-btn"
      >
        <i class="fas fa-vial"></i> Initiate New Test
      </a>
    </div>
    {% endfor %}
  </section>
</div> {% endcomment %}

<div class="dashboard-layout">
  <aside class="side-panel">
    <div class="profile-header-card">
      <i class="fas fa-user-shield profile-icon"></i>
      <h3 class="profile-name">
        {{ profile.user.get_full_name|default:'Patient User' }}
      </h3>
      <span class="profile-role">Patient ID: {{ profile.user.id }}</span>
    </div>

    <div class="data-block">
      <h4 class="block-title"><i class="fas fa-id-card-alt"></i> Personal Details</h4>
      <div class="data-grid">
        <div class="data-item">
          <span class="data-label"><i class="fas fa-venus-mars"></i> Sex</span>
          <span class="data-value">{{ profile.sex|default:'N/A' }}</span>
        </div>
        <div class="data-item">
          <span class="data-label"><i class="fas fa-calendar-alt"></i> Age</span>
          <span class="data-value">{{ profile.age|default:'N/A' }}</span>
        </div>
        <div class="data-item">
          <span class="data-label"><i class="fas fa-tint"></i> Blood Group</span>
          <span class="data-value">{{ profile.blood_group|default:'N/A' }}</span>
        </div>
      </div>
    </div>

    <div class="action-buttons-stack">
      <a href="{% url 'clinical_entry' %}" class="action-btn-primary">
        <i class="fas fa-notes-medical"></i> Enter Clinical Data
      </a>
      <a href="{% url 'upload_pap' %}" class="action-btn-secondary">
        <i class="fas fa-upload"></i> Upload Pap Image
      </a>
      {% comment %} <a href="{% url 'update_patient_profile' %}" class="action-btn-tertiary">
        <i class="fas fa-user-edit"></i> Edit Profile
      </a> {% endcomment %}
    </div>
  </aside>

  <section class="main-content">
    <h2 class="section-title"><i class="fas fa-history"></i> Comprehensive Test History</h2>

    {% for r in records %}
    <div class="test-record-card">
      <header class="record-card-header">
        <span class="test-date-time">
          <i class="far fa-clock"></i> {{ r.created_at|date:"F j, Y, h:i A" }}
        </span>

        <div class="status-tags">
          {% if r.referral_status == 'R' %}
            <span class="tag-alert referred-tag"><i class="fas fa-user-md"></i> Consult Required</span>
          {% elif r.fused_label == 'High' %}
            <span class="tag-alert high-risk-tag"><i class="fas fa-radiation"></i> High Risk Result</span>
          {% elif r.fused_label == 'Medium' %}
            <span class="tag-alert medium-risk-tag"><i class="fas fa-exclamation-circle"></i> Medium Risk</span>
          {% else %}
            <span class="tag-alert low-risk-tag"><i class="fas fa-check-circle"></i> Low Risk</span>
          {% endif %}
        </div>

        <a href="{% url 'patient_detail' r.id %}" class="view-details-link">
          View Full Report <i class="fas fa-arrow-right"></i>
        </a>
      </header>

      <div class="prediction-summary-grid">
        <!-- Clinical -->
        <div class="prediction-tile clinical-tile">
          <div class="tile-header"><i class="fas fa-stethoscope"></i> Clinical Prediction</div>
          <div class="tile-body">
            <span class="tile-label-main label-{{ r.clinical_pred_label|default:'n/a' }}">
              {{ r.clinical_pred_label|default:'N/A' }}
            </span>
            <span class="tile-score">
              {% if r.clinical_risk_score is not None %}
                Risk Score: {{ r.clinical_risk_score|floatformat:10 }}
              {% else %}
                Risk Score: N/A
              {% endif %}
            </span>
          </div>
        </div>

        <!-- Image -->
          <div class="prediction-tile image-tile">
            <div class="tile-header"><i class="fas fa-microscope"></i> Image Prediction</div>
            <div class="tile-body">
              <span class="tile-label-main label-{{ r.image_label|default_if_none:'n-a'|lower }}">
                {{ r.image_label|default_if_none:'N/A' }}
              </span>
              <span class="tile-score" title="{{ r.image_prob }}">
                {% if r.image_prob is not None %}
                  Probability: {{ r.image_prob|floatformat:10 }}
                {% else %}
                  Probability: N/A
                {% endif %}
              </span>
            </div>
          </div>

          <!-- Fused -->
          <div class="prediction-tile fused-tile">
            <div class="tile-header"><i class="fas fa-brain"></i> Fused Result</div>
            <div class="tile-body">
              <span class="tile-label-final label-{{ r.fused_label|lower }}">
                {{ r.fused_label|default:'N/A' }}
              </span>
              <span class="tile-score" title="{{ r.fused_score }}">
                Fusion Score: {{ r.fused_score|floatformat:4|default:'N/A' }}
              </span>
            </div>
          </div>

        </div>

        <!-- Final Result (Centered Row) -->
        <div class="final-result-row">
          <div class="prediction-tile fused-tile">
            <div class="tile-header"><i class="fas fa-chart-line"></i> Final Result</div>
            <div class="tile-body">
              <span class="tile-label-final">
                {% if r.final_percentage is not None %}
                  {{ r.final_percentage|floatformat:1 }}%
                {% else %}
                  N/A
                {% endif %}
              </span>
              <span class="tile-score">
                Weighted Score
              </span>
            </div>
          </div>
        </div>

      <div class="explanation-visuals-section">
        <h6 class="visual-section-title"><i class="fas fa-chart-bar"></i> AI Explanation:</h6>
        <div class="visuals-container">
          {% if r.gradcam_path %}
            <figure class="visual-figure">
              <img src="{% static r.gradcam_path %}" alt="GradCAM Visualization" title="Image Explanation (Grad-CAM)" />
              <figcaption>Grad-CAM</figcaption>
            </figure>
          {% endif %}

          {% if r.clinical_shap_path %}
            <figure class="visual-figure">
              <img src="{% static r.clinical_shap_path %}" alt="SHAP Explanation" title="Clinical Explanation (SHAP)" />
              <figcaption>SHAP Plot</figcaption>
            </figure>
          {% endif %}

          {% if not r.gradcam_path and not r.clinical_shap_path %}
            <p class="no-visuals-text"><i class="fas fa-eye-slash"></i> No detailed visualizations available for this test.</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
      <div class="empty-state-advanced">
        <i class="fas fa-folder-open"></i>
        <p>Your record history is currently empty.</p>
        <p>Start your journey by submitting a new test for analysis.</p>
        <a href="{% url 'clinical_entry' %}" class="action-btn-primary large-empty-btn">
          <i class="fas fa-vial"></i> Initiate New Test
        </a>
      </div>
    {% endfor %}
  </section>
</div>



<style>
  /* --- 1. MODERN COLOR PALETTE & VARIABLES --- */
  :root {
    --color-bg-primary: #121926; /* Dark Navy/Black for main background */
    --color-card-primary: #1e293b; /* Deep Slate Blue for cards */
    --color-card-secondary: #273449; /* Slightly lighter card hover/subtle elements */
    --color-accent-primary: #34d399; /* Bright mint green for primary actions (Success/Low Risk) */
    --color-accent-secondary: #60a5fa; /* Cool blue for secondary actions/icons */
    --color-text-light: #f1f5f9; /* Off-white for main text */
    --color-text-muted: #94a3b8; /* Slate gray for secondary text/labels */

    /* Status Colors */
    --color-status-low: var(--color-accent-primary); /* Mint Green */
    --color-status-medium: #facc15; /* Yellow/Gold */
    --color-status-high: #f87171; /* Soft Red/Coral */
    --color-status-referred: #ef4444; /* Bright Red */
  }

  /* --- 2. LAYOUT AND STRUCTURE (Grid) --- */
  .dashboard-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 35px;
    padding: 30px;
    max-width: 1500px;
    margin: 0 auto;
    background-color: var(--color-bg-primary);
    min-height: 100vh;
  }

  /* Base Card Styling */
  .side-panel,
  .main-content {
    background-color: var(--color-bg-primary);
    border-radius: 12px;
  }

  /* --- 3. SIDE PANEL (Profile) --- */
  .side-panel {
    display: flex;
    flex-direction: column;
    gap: 25px;
  }

  .profile-header-card {
    background: linear-gradient(
      135deg,
      var(--color-card-secondary) 0%,
      var(--color-card-primary) 100%
    );
    padding: 30px 20px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  .profile-icon {
    font-size: 3rem;
    color: var(--color-accent-primary);
    margin-bottom: 10px;
    display: block;
  }
  .profile-name {
    color: var(--color-text-light);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 5px;
  }
  .profile-role {
    color: var(--color-text-muted);
    font-size: 0.9rem;
  }

  /* Inside the <style> block, around line 214 */

.data-block {
    background-color: var(--color-card-primary);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    /* ðŸ’¥ INCREASED NEGATIVE MARGIN TO REDUCE GAP */
    margin-bottom: -25px; 
}
  .block-title {
    color: var(--color-accent-secondary);
    font-size: 1.1rem;
    font-weight: 600;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding-bottom: 10px;
    margin-bottom: 15px;
  }
  .block-title i {
    margin-right: 8px;
  }
  .data-grid {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .data-item {
    display: flex;
    justify-content: space-between;
  }
  .data-label {
    color: var(--color-text-muted);
    font-size: 0.95rem;
  }
  .data-value {
    color: var(--color-text-light);
    font-weight: 600;
  }
  .data-label i {
    margin-right: 8px;
    color: var(--color-accent-secondary);
  }

  /* Action Buttons */
  .action-buttons-stack {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: auto; /* Pushes buttons to the bottom */
  }
  .action-btn-primary,
  .action-btn-secondary,
  .action-btn-tertiary {
    display: block;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    text-decoration: none;
  }
  .action-btn-primary {
    background-color: var(--color-accent-primary);
    color: var(--color-bg-primary);
    box-shadow: 0 4px 15px rgba(52, 211, 153, 0.3);
  }
  .action-btn-primary:hover {
    background-color: #2bbd87;
    transform: translateY(-2px);
  }
  .action-btn-secondary {
    background-color: var(--color-card-secondary);
    color: var(--color-text-light);
    border: 1px solid var(--color-accent-secondary);
  }
  .action-btn-secondary:hover {
    background-color: var(--color-accent-secondary);
    color: var(--color-bg-primary);
  }
  .action-btn-tertiary {
    background-color: transparent;
    color: var(--color-text-muted);
    border: 1px solid var(--color-text-muted);
  }
  .action-btn-tertiary:hover {
    color: var(--color-accent-secondary);
    border-color: var(--color-accent-secondary);
  }

  /* --- 4. MAIN CONTENT (Test Records) --- */
  .section-title {
    color: var(--color-text-light);
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 30px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--color-accent-secondary);
  }
  .section-title i {
    color: var(--color-accent-secondary);
    margin-right: 15px;
  }

  .test-record-card {
    background-color: var(--color-card-primary);
    padding: 30px;
    border-radius: 10px;
    margin-bottom: 25px;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-left: 5px solid var(--color-accent-secondary); /* Accent border */
  }
  .test-record-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.7);
  }

  .record-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 20px;
    margin-bottom: 20px;
    border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
  }
  .test-date-time {
    color: var(--color-accent-primary);
    font-size: 1.1rem;
    font-weight: 600;
  }
  .test-date-time i {
    margin-right: 8px;
  }
  .view-details-link {
    background-color: var(--color-accent-secondary);
    color: var(--color-bg-primary);
    padding: 8px 15px;
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }
  .view-details-link:hover {
    background-color: #4b8de8; /* Slightly darker blue */
  }

  /* Status Tags */
  .status-tags {
    display: flex;
    gap: 10px;
  }
  .tag-alert {
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .referred-tag {
    background-color: var(--color-status-referred);
    color: var(--color-text-light);
  }
  .high-risk-tag {
    background-color: var(--color-status-high);
    color: var(--color-text-light);
  }
  .medium-risk-tag {
    background-color: var(--color-status-medium);
    color: var(--color-bg-primary);
  }
  .low-risk-tag {
    background-color: var(--color-status-low);
    color: var(--color-bg-primary);
  }

  /* Prediction Tiles */
  .prediction-summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 25px;
  }

  .final-result-row {
    display: flex;
    justify-content: center;
    margin-bottom: 25px;
  }

  .final-result-row .prediction-tile {
    width: 100%;
    max-width: 350px;
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
    border: 1px solid var(--color-accent-secondary);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  }

  .prediction-tile {
    background-color: var(--color-card-secondary);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .tile-header {
    font-size: 0.9rem;
    color: var(--color-text-muted);
    padding-bottom: 8px;
    margin-bottom: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }
  .tile-header i {
    margin-right: 5px;
    color: var(--color-accent-secondary);
  }

  .tile-body {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .tile-label-main,
  .tile-label-final {
    font-size: 1.5rem;
    font-weight: 800;
    letter-spacing: 1px;
    margin-bottom: 5px;
  }
  .tile-score {
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }

  /* Dynamic Label Coloring for Tiles */
  .label-low,
  .label-negative,
  .label-benign {
    color: var(--color-status-low);
  }
  .label-medium {
    color: var(--color-status-medium);
  }
  .label-high,
  .label-positive,
  .label-malignant {
    color: var(--color-status-high);
  }

  .fused-tile .tile-label-final {
    padding: 5px 15px;
    border-radius: 4px;
    background-color: rgba(
      255,
      255,
      255,
      0.1
    ); /* Subtle background for final score */
  }

  /* Explanation Visuals */
  .explanation-visuals-section {
    padding-top: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }
  .visual-section-title {
    color: var(--color-text-light);
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 15px;
  }
  .visual-section-title i {
    color: var(--color-accent-secondary);
    margin-right: 10px;
  }

  .visuals-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }

  .visual-figure {
    margin: 0;
    text-align: center;
  }
  .visual-figure img {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid var(--color-accent-secondary);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
    transition: transform 0.2s ease;
  }
  .visual-figure img:hover {
    transform: scale(1.03);
  }
  .visual-figure figcaption {
    margin-top: 5px;
    font-size: 0.8rem;
    color: var(--color-text-muted);
  }

  .no-visuals-text {
    color: var(--color-text-muted);
    font-style: italic;
    padding: 10px;
  }
  .no-visuals-text i {
    margin-right: 5px;
  }

  /* Empty State */
  .empty-state-advanced {
    padding: 60px;
    text-align: center;
    background-color: var(--color-card-secondary);
    border: 3px dashed var(--color-accent-secondary);
    border-radius: 12px;
    margin-top: 30px;
  }
  .empty-state-advanced i {
    font-size: 3rem;
    color: var(--color-accent-secondary);
    margin-bottom: 15px;
  }
  .empty-state-advanced p {
    color: var(--color-text-muted);
    font-size: 1.1rem;
    margin-bottom: 5px;
  }
  .large-empty-btn {
    margin-top: 25px;
    padding: 15px 30px !important;
    font-size: 1.1rem !important;
  }

  /* --- 5. RESPONSIVENESS --- */
  @media (max-width: 1100px) {
    .dashboard-layout {
      grid-template-columns: 1fr; /* Stack panels vertically */
      padding: 20px;
    }
    .side-panel {
      order: -1; /* Place profile panel at the top */
    }
  }

  @media (max-width: 768px) {
    .record-card-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }
    .status-tags {
      order: -1; /* Move tags above date */
    }
    .view-details-link {
      width: 100%; /* Full width button on mobile */
    }
    .prediction-summary-grid {
      grid-template-columns: 1fr; /* Stack prediction blocks */
    }
    .visuals-container {
      justify-content: center;
    }
  }
</style>

{% endblock content %}
